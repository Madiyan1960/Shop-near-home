<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–∞–≥–∞–∑–∏–Ω —É –¥–æ–º–∞</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; background: #f4f4f4; }
    h1 { text-align: center; color: #2e7d32; }
    .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.7rem; }
    .product { background: white; padding: 0.6rem; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
    .product img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
    .product h3 { margin: 0.4rem 0 0.2rem; font-size: 0.9rem; }
    .product p { margin: 0; font-size: 0.85rem; color: #555; }
    .add-btn { margin-top: 0.4rem; padding: 0.3rem 0.5rem; background: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; }

    /* Responsive */
    @media (max-width: 600px) {
      .product-list { grid-template-columns: repeat(2, 1fr); }
    }

    #cart-button {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: #388e3c;
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      z-index: 100;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã */
    #cart-modal {
      display: none;
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-width: 350px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }

    #cart-items {
      margin-bottom: 1rem;
    }

    #cart-items div {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #cart-items button {
      background: #e53935;
      color: white;
      border: none;
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h3>–ú–∞–≥–∞–∑–∏–Ω —É –¥–æ–º–∞</h3>

<!-- –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
<button id="cart-button">–ö–æ—Ä–∑–∏–Ω–∞ (0)</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ—Ä–∑–∏–Ω—ã -->
<div id="cart-modal">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cart-items"></div>
  <button onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
  <button onclick="sendCart()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div id="product-list" class="product-list"></div>

<audio id="click-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoChjmnMdjDn-siHAEHrBpDaz-3tkFx68Peo1LXU_Nc8R5XTm5Gee2pi-O9jz1XyYhhCGCDnTKa0cR/pub?gid=0&single=true&output=csv";
  let cart = JSON.parse(localStorage.getItem("cart")) || [];

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∫–æ—Ä–∑–∏–Ω—ã
  function updateCartButton() {
    document.getElementById("cart-button").textContent = `–ö–æ—Ä–∑–∏–Ω–∞ (${cart.length})`;
  }

  // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
  function clearCart() {
    cart = [];
    saveCart();
    updateCartButton();
    showCart();
  }

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
  function sendCart() {
    const cartData = cart.map(item => `${item.name} ‚Äì ${item.price} √ó ${item.count}`).join("\n");
    alert(`–ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: \n${cartData}`);
  }

  // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –≤ localStorage
  function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
  function showCart() {
    const modal = document.getElementById("cart-modal");
    modal.style.display = modal.style.display === "block" ? "none" : "block";

    const container = document.getElementById("cart-items");
    container.innerHTML = "";

    cart.forEach((p, index) => {
      const item = document.createElement("div");
      item.innerHTML = `
        <p>
          ${p.name} ‚Äì ${p.price} √ó ${p.count}
          <button onclick="removeItem(${index})">üóë</button>
        </p>
      `;
      container.appendChild(item);
    });
  }

  // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
  function removeItem(index) {
    cart.splice(index, 1);
    saveCart();
    updateCartButton();
    showCart();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ CSV
  async function loadProductsFromCSV() {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const lines = text.trim().split("\n");
    const products = lines.slice(1).map(line => {
      const [name, price, image] = line.split(",");
      return { name, price, image };
    });

    const list = document.getElementById("product-list");
    list.innerHTML = "";
    products.forEach(p => {
      const el = document.createElement("div");
      el.className = "product";
      el.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>${p.price}</p>
        <button class="add-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
      `;

      const button = el.querySelector(".add-btn");

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ, –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
      const existingInCart = cart.find(item => item.name === p.name);
      if (existingInCart) {
        button.textContent = "–í –∫–æ—Ä–∑–∏–Ω–µ";
        button.disabled = true;
      }

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
      button.addEventListener("click", () => {
        document.getElementById("click-sound").play(); // –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫

        const existing = cart.find(item => item.name === p.name);
        if (existing) {
          existing.count += 1;
        } else {
          cart.push({ ...p, count: 1 });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –∏ –∫–Ω–æ–ø–∫—É
        saveCart();
        updateCartButton();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –¥–µ–ª–∞–µ–º –µ—ë –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
        button.textContent = "–í –∫–æ—Ä–∑–∏–Ω–µ";
        button.disabled = true;

        // –ê–Ω–∏–º–∞—Ü–∏—è
        const img = el.querySelector("img");
        const imgRect = img.getBoundingClientRect();
        const cartBtn = document.getElementById("cart-button");
        const cartRect = cartBtn.getBoundingClientRect();

        const flyingImg = img.cloneNode(true);
        flyingImg.style.position = "fixed";
        flyingImg.style.zIndex = "1000";
        flyingImg.style.left = imgRect.left + "px";
        flyingImg.style.top = imgRect.top + "px";
        flyingImg.style.width = imgRect.width + "px";
        flyingImg.style.height = imgRect.height + "px";
        flyingImg.style.transition = "all 0.8s ease-in-out";
        document.body.appendChild(flyingImg);

        requestAnimationFrame(() => {
          flyingImg.style.left = cartRect.left + "px";
          flyingImg.style.top = cartRect.top + "px";
          flyingImg.style.width = "30px";
          flyingImg.style.height = "30px";
          flyingImg.style.opacity = "0.5";
        });

        setTimeout(() => flyingImg.remove(), 900);
      });

      list.appendChild(el);
    });
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
  loadProductsFromCSV();

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
  document.getElementById("cart-button").addEventListener("click", showCart);
</script>

</body>
</html>
