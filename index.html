<script>
  async function loadProductsFromCSV() {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const lines = text.trim().split("\n");
    const products = lines.slice(1).map(line => {
      const [name, price, image] = line.split(",");
      return { name, price, image };
    });

    const list = document.getElementById("product-list");
    list.innerHTML = "";
    products.forEach(p => {
      const el = document.createElement("div");
      el.className = "product";
      el.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>${p.price}</p>
        <button class="add-btn">Добавить</button>
      `;
      
      const addButton = el.querySelector(".add-btn");
      
      addButton.addEventListener("click", () => {
        document.getElementById("click-sound").play(); // звук

        const existing = cart.find(item => item.name === p.name);
        if (existing) {
          existing.count += 1;
        } else {
          cart.push({ ...p, count: 1 });
        }
        saveCart();
        updateCartButton();

        // Обновляем состояние кнопки
        addButton.textContent = "В корзине";
        addButton.disabled = true;

        // Анимация
        const img = el.querySelector("img");
        const imgRect = img.getBoundingClientRect();
        const cartBtn = document.getElementById("cart-button");
        const cartRect = cartBtn.getBoundingClientRect();

        const flyingImg = img.cloneNode(true);
        flyingImg.style.position = "fixed";
        flyingImg.style.zIndex = "1000";
        flyingImg.style.left = imgRect.left + "px";
        flyingImg.style.top = imgRect.top + "px";
        flyingImg.style.width = imgRect.width + "px";
        flyingImg.style.height = imgRect.height + "px";
        flyingImg.style.transition = "all 0.8s ease-in-out";
        document.body.appendChild(flyingImg);

        requestAnimationFrame(() => {
          flyingImg.style.left = cartRect.left + "px";
          flyingImg.style.top = cartRect.top + "px";
          flyingImg.style.width = "30px";
          flyingImg.style.height = "30px";
          flyingImg.style.opacity = "0.5";
        });

        setTimeout(() => flyingImg.remove(), 900);
      });

      list.appendChild(el);
    });
  }

  function clearCart() {
    cart = [];
    saveCart();
    updateCartButton();
    showCart();

    // Сделаем все кнопки активными
    const buttons = document.querySelectorAll(".add-btn");
    buttons.forEach(btn => {
      btn.textContent = "Добавить";
      btn.disabled = false;
    });
  }
</script>
