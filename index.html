<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Магазин</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .product { display: inline-block; width: 45%; margin: 10px 0; text-align: center; }
        .product img { width: 100%; max-width: 200px; }
        #cart { position: fixed; right: 10px; bottom: 10px; background-color: #fff; padding: 10px; border: 1px solid #ccc; }
        #cart-items { list-style: none; padding: 0; }
        #cart-items li { margin: 5px 0; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #submit-order { margin-top: 10px; background-color: #f44336; }
        #order-form input, #order-form button { margin: 5px 0; padding: 10px; width: 100%; }
    </style>
</head>
<body>
    <div id="products"></div>

    <div id="cart">
        <h3>Корзина</h3>
        <ul id="cart-items"></ul>
        <p id="total-price">Итого: 0 тг</p>
        <button id="submit-order" onclick="showOrderForm()">Отправить</button>
    </div>

    <div id="order-form" style="display: none;">
        <h3>Введите ваши данные для заказа</h3>
        <form onsubmit="submitOrder(event)">
            <input type="text" id="name" placeholder="Имя" required />
            <input type="tel" id="phone" placeholder="Телефон" required />
            <input type="text" id="address" placeholder="Адрес" required />
            <button type="submit">Отправить заказ</button>
        </form>
    </div>

    <script>
        // Загружаем товары из Airtable
        function loadProducts() {
            fetch('https://shrill-haze-b867.mironovka6.workers.dev/products')
            .then(res => {
                console.log("Запрос выполнен, статус:", res.status);
                return res.json();
            })
            .then(data => {
                console.log("Загружены товары:", data);
                if (data.length === 0) {
                    console.error("Нет данных о товарах");
                    return;
                }

                const container = document.getElementById('products');
                data.forEach(record => {
                    const fields = record.fields;
                    const name = fields['Products'];
                    const price = fields['Price'];
                    const imgUrl = fields['Image']?.[0]?.url;

                    const div = document.createElement('div');
                    div.className = 'product';
                    div.innerHTML = `
                        <h3>${name}</h3>
                        <img src="${imgUrl}" alt="${name}">
                        <p>Цена: ${price} тг</p>
                        <button onclick="addToCart('${name}', ${price}, '${imgUrl}')">В корзину</button>
                    `;
                    container.appendChild(div);
                });
            })
            .catch(err => {
                console.error("Ошибка при загрузке товаров:", err);
            });
        }

        // Инициализация корзины
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        function addToCart(name, price, imgUrl) {
            const product = { name, price, quantity: 1, imgUrl };
            const existingProduct = cart.find(item => item.name === name);

            if (existingProduct) {
                existingProduct.quantity += 1;
            } else {
                cart.push(product);
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
        }

        // Обновление корзины
        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';

            let totalPrice = 0;
            cart.forEach(item => {
                totalPrice += item.price * item.quantity;
                const li = document.createElement('li');
                li.innerHTML = `${item.name} - ${item.quantity} x ${item.price} тг`;
                cartItemsContainer.appendChild(li);
            });

            document.getElementById('total-price').innerText = `Итого: ${totalPrice} тг`;
        }

        // Показываем форму для заказа
        function showOrderForm() {
            if (cart.length === 0) {
                alert("Ваша корзина пуста. Добавьте товары в корзину перед отправкой.");
                return;
            }
            document.getElementById('order-form').style.display = 'block';
        }

        // Отправка заказа в Airtable
        function submitOrder(event) {
            event.preventDefault();

            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            // Формируем заказ
            const order = {
                fields: {
                    Name: name,
                    Phone: phone,
                    Address: address,
                    Products: cart.map(item => `${item.name} (${item.quantity} x ${item.price} тг)`).join(", "),
                    Total: cart.reduce((total, item) => total + (item.price * item.quantity), 0)
                }
            };

            // Отправка данных в Airtable
            fetch('https://api.airtable.com/v0/YOUR_BASE_ID/Orders', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer YOUR_API_KEY',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(order)
            })
            .then(response => response.json())
            .then(data => {
                console.log("Данные успешно отправлены в Airtable:", data);
                alert("Ваш заказ успешно отправлен!");

                // Очистка корзины
                localStorage.removeItem('cart');
                cart = [];
                updateCart();

                // Скрытие формы
                document.getElementById('order-form').style.display = 'none';
            })
            .catch(err => {
                console.error("Ошибка при отправке данных в Airtable:", err);
            });
        }

        // Загружаем товары при старте
        loadProducts();
        updateCart();  // Инициализируем корзину при загрузке страницы
    </script>
</body>
</html>
