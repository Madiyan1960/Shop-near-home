<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoChjmnMdjDn-siHAEHrBpDaz-3tkFx68Peo1LXU_Nc8R5XTm5Gee2pi-O9jz1XyYhhCGCDnTKa0cR/pub?gid=0&single=true&output=csv";

  let cart = [];

  function saveCart() {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  function loadCart() {
    const data = localStorage.getItem("cart");
    if (data) {
      try {
        cart = JSON.parse(data);
      } catch (e) {
        cart = [];
      }
    }
  }

  function updateCartButton() {
    document.getElementById("cart-button").textContent = `Корзина (${cart.length})`;
  }

  function showCart() {
    const modal = document.getElementById("cart-modal");
    modal.style.display = modal.style.display === "block" ? "none" : "block";
    const container = document.getElementById("cart-items");
    container.innerHTML = cart.map(p => `<p>${p.name} - ${p.price}</p>`).join("");
  }

  async function loadProductsFromCSV() {
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const lines = text.trim().split("\n");
    const products = lines.slice(1).map(line => {
      const [name, price, image] = line.split(",");
      return { name, price, image };
    });

    const list = document.getElementById("product-list");
    list.innerHTML = "";
    products.forEach(p => {
      const el = document.createElement("div");
      el.className = "product";
      el.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>${p.price}</p>
        <button class="add-btn">Добавить</button>
      `;
      el.querySelector(".add-btn").addEventListener("click", () => {
        cart.push(p);
        saveCart();
        updateCartButton();
      });
      list.appendChild(el);
    });
  }

  // Инициализация
  loadCart();
  updateCartButton();
  document.getElementById("cart-button").addEventListener("click", showCart);
  loadProductsFromCSV();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
