<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Магазин</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .product { display: inline-block; width: 45%; margin: 10px 0; text-align: center; }
        .product img { width: 100%; max-width: 200px; }
        #cart { position: fixed; right: 10px; bottom: 10px; background-color: #fff; padding: 10px; border: 1px solid #ccc; }
        #cart-items { list-style: none; padding: 0; }
        #cart-items li { margin: 5px 0; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #submit-order { margin-top: 10px; background-color: #f44336; }
    </style>
</head>
<body>
    <div id="products"></div>

    <div id="cart">
        <h3>Корзина</h3>
        <ul id="cart-items"></ul>
        <p id="total-price">Итого: 0 тг</p>
        <button id="submit-order" onclick="submitOrder()">Отправить</button>
    </div>

    <script>
        // Загружаем товары из Airtable
        function loadProducts() {
            fetch('https://shrill-haze-b867.mironovka6.workers.dev/products')
            .then(res => {
                console.log("Запрос выполнен, статус:", res.status); // Выводим статус ответа
                return res.json();
            })
            .then(data => {
                console.log("Загружены товары:", data); // Проверим, что данные приходят
                if (data.length === 0) {
                    console.error("Нет данных о товарах");
                    return;
                }

                const container = document.getElementById('products');
                data.forEach(record => {
                    const fields = record.fields;
                    const name = fields['Products'];
                    const price = fields['Price'];
                    const imgUrl = fields['Image']?.[0]?.url;

                    const div = document.createElement('div');
                    div.className = 'product';
                    div.innerHTML = `
                        <h3>${name}</h3>
                        <img src="${imgUrl}" alt="${name}">
                        <p>Цена: ${price} тг</p>
                        <button onclick="addToCart('${name}', ${price})">В корзину</button>
                    `;
                    container.appendChild(div);
                });
            })
            .catch(err => {
                console.error("Ошибка при загрузке товаров:", err);
            });
        }

        // Добавляем товар в корзину
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        function addToCart(name, price) {
            const product = { name, price, quantity: 1 };
            const existingProduct = cart.find(item => item.name === name);

            if (existingProduct) {
                existingProduct.quantity += 1;  // Увеличиваем количество
            } else {
                cart.push(product);
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
        }

        // Обновляем корзину
        function updateCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            cartItemsContainer.innerHTML = '';

            let totalPrice = 0;
            cart.forEach(item => {
                totalPrice += item.price * item.quantity;
                const li = document.createElement('li');
                li.innerHTML = `${item.name} - ${item.quantity} x ${item.price} тг`;
                cartItemsContainer.appendChild(li);
            });

            document.getElementById('total-price').innerText = `Итого: ${totalPrice} тг`;
        }

        // Отправить заказ
        function submitOrder() {
            if (cart.length === 0) {
                alert("Ваша корзина пуста. Добавьте товары в корзину перед отправкой.");
                return;
            }

            // Для примера отправим заказ через console.log. В реальном проекте сюда будет добавлена логика отправки на сервер
            console.log("Заказ отправлен:", cart);

            // Очистим корзину после отправки
            localStorage.removeItem('cart');
            cart = [];
            updateCart();  // Обновляем корзину после отправки
            alert("Ваш заказ отправлен!");
        }

        loadProducts();
        updateCart();  // Инициализируем корзину при загрузке страницы
    </script>
</body>
</html>
