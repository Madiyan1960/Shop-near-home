<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta charset="UTF-8">
  <title>–ú–∏–Ω–∏-–º–∞–≥–∞–∑–∏–Ω</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .product {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .product img { width: 100%; border-radius: 6px; }
    .product button {
      margin-top: auto;
      background: #2e7d32;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .product button:hover { background: #1b5e20; }
    #cart { margin-top: 20px; border-top: 1px dashed #999; padding-top: 10px; }
  </style>
</head>
<body>

<h2>üõçÔ∏è –ú–∏–Ω–∏-–º–∞–≥–∞–∑–∏–Ω</h2>
<div class="grid" id="products">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<h3>üß∫ –ö–æ—Ä–∑–∏–Ω–∞</h3>
<div id="cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>

<h3>üì¶ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞</h3>
<form id="orderForm">
  <label for="name">–ò–º—è:</label>
  <input type="text" id="name" name="name" required><br><br>

  <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
  <input type="tel" id="phone" name="phone" pattern="^\+?\d{1,15}$" required><br><br>
  <small>–¢–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ: +77770000000</small><br><br>

  <label for="address">–ê–¥—Ä–µ—Å:</label>
  <textarea id="address" name="address" required></textarea><br><br>

  <button type="button" onclick="submitOrder()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
</form>

<script>
  const API_TOKEN = 'your_airtable_token';  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π PAT
  const BASE_ID = 'your_base_id';           // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π Base ID
  const TABLE_NAME = '–∑–∞–∫–∞–∑—ã';              // –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤

  const API_URL = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
  const HEADERS = { Authorization: `Bearer ${API_TOKEN}`, 'Content-Type': 'application/json' };

  const cart = [];

  function renderCart() {
    const c = document.getElementById('cart');
    if (!cart.length) return c.innerHTML = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
    let total = 0;
    c.innerHTML = '<ul>' + cart.map((i, index) => {
      total += i.price * i.quantity;
      return `
        <li>
          ${index + 1}. ${i.name} ‚Äì ${i.price} ‚Ç∏ √ó ${i.quantity}
          <button onclick="removeFromCart(${index})">–£–¥–∞–ª–∏—Ç—å</button>
          <button onclick="updateQuantity(${index}, -1)">-</button>
          <button onclick="updateQuantity(${index}, 1)">+</button>
        </li>
      `;
    }).join('') + `</ul><b>–ò—Ç–æ–≥–æ: ${total} —Ç–≥</b>`;
  }

  function addToCart(name, price) {
    const existingProduct = cart.find(item => item.name === name);
    if (existingProduct) {
      existingProduct.quantity += 1;
    } else {
      cart.push({ name, price, quantity: 1 });
    }
    renderCart();
  }

  function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
  }

  function updateQuantity(index, delta) {
    if (cart[index].quantity + delta > 0) {
      cart[index].quantity += delta;
      renderCart();
    }
  }

  function submitOrder() {
    const name = document.getElementById('name').value;
    const phone = document.getElementById('phone').value;
    const address = document.getElementById('address').value;

    if (!name || !phone || !address || !cart.length) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É.");
      return;
    }

    const orderDetails = cart.map((item, index) => {
      return `${index + 1}. ${item.name} (${item.price} ‚Ç∏) √ó ${item.quantity}`;
    }).join('\n');

    const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

    const order = {
      fields: {
        'Time': new Date().toLocaleString(),
        'Name': name,
        'Phone': phone,
        'Address': address,
        'Items': orderDetails,
        'Total': totalAmount,
        'Status': '–ù–æ–≤—ã–π'
      }
    };

    sendOrderToDatabase(order);
  }

  function sendOrderToDatabase(order) {
    fetch(API_URL, {
      method: 'POST',
      headers: HEADERS,
      body: JSON.stringify(order)
    })
    .then(response => response.json())
    .then(() => {
      alert('–í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
      cart.length = 0;
      renderCart();
      document.getElementById('orderForm').reset();
    })
    .catch(error => {
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      console.error(error);
    });
  }

  fetch(`https://api.airtable.com/v0/${BASE_ID}/–¢–æ–≤–∞—Ä—ã`, { headers: HEADERS })
    .then(r => r.json())
    .then(data => {
      const p = document.getElementById('products');
      p.innerHTML = '';
      data.records.forEach(r => {
        const f = r.fields;
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
          <img src="${f['–§–æ—Ç–æ']?.[0]?.url || ''}" alt="">
          <div><b>${f['–ù–∞–∑–≤–∞–Ω–∏–µ']}</b></div>
          <div>${f['–¶–µ–Ω–∞']} —Ç–≥</div>
          <button onclick="addToCart('${f['–ù–∞–∑–≤–∞–Ω–∏–µ']}', ${f['–¶–µ–Ω–∞']})">–î–æ–±–∞–≤–∏—Ç—å</button>
        `;
        p.appendChild(div);
      });
    })
    .catch(() => document.getElementById('products').innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
</script>

</body>
</html>
