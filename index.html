<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Магазин у дома</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    header { background: #2e7d32; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; padding: 1rem; }
    .product { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
    .product img { max-width: 100%; height: auto; border-radius: 8px; }
    .product h3 { margin: 0.5rem 0; font-size: 1.1rem; }
    .product p { margin: 0.5rem 0; font-weight: bold; color: #2e7d32; }
    .product button { padding: 0.5rem 1rem; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .product button:disabled { background: #aaa; cursor: default; }
    #cart-button { background: white; color: #2e7d32; border: 2px solid #2e7d32; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
    #cart-modal { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; max-width: 90%; max-height: 80%; overflow: auto; }
    #cart-modal h2 { margin-top: 0; }
    #cart-items { margin: 1rem 0; }
    .cart-item { display: flex; justify-content: space-between; margin: 0.5rem 0; }
    #close-cart { float: right; background: #ccc; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; }
    #overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 999; }
  </style>
</head>
<body>

<header>
  <h1>Магазин у дома</h1>
  <button id="cart-button">Корзина (0)</button>
</header>

<main>
  <div class="products" id="product-list"></div>
</main>

<div id="overlay"></div>

<div id="cart-modal">
  <button id="close-cart">✖</button>
  <h2>Корзина</h2>
  <div id="cart-items"></div>
  <button onclick="clearCart()">Очистить корзину</button>
</div>

<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_pXRvdzbuFgLL4upSR8pFOcglKVHLpxVoOLXSopswlDpzg2eNgl4WtziV1hnpHwn3CuWtimsTf-0W/pub?gid=536909118&single=true&output=csv';

  let cart = JSON.parse(localStorage.getItem('cart') || '[]');

  function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  function updateCartButton() {
    const total = cart.reduce((sum, item) => sum + item.count, 0);
    document.getElementById('cart-button').textContent = `Корзина (${total})`;
  }

  // Корректный CSV парсер
  function parseCSV(csv) {
    const rows = [];
    const lines = csv.split(/\r?\n/);
    const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.replace(/^"|"$/g, ''));
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
      if (values.length === headers.length) {
        const obj = {};
        headers.forEach((h, j) => obj[h] = values[j]);
        rows.push(obj);
      }
    }
    return rows;
  }

  async function loadProductsFromCSV() {
    const res = await fetch(sheetURL);
    const text = await res.text();
    const products = parseCSV(text);
    const list = document.getElementById('product-list');
    list.innerHTML = '';

    products.forEach(p => {
      const el = document.createElement("div");
      el.className = "product";
      el.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <h3>${p.name}</h3>
        <p>${p.price}</p>
        <button class="add-btn">Добавить</button>
      `;

      const btn = el.querySelector(".add-btn");

      const updateButtonState = () => {
        const inCart = cart.some(item => item.name === p.name);
        btn.disabled = inCart;
        btn.textContent = inCart ? "В корзине" : "Добавить";
      };

      btn.addEventListener("click", () => {
        const existing = cart.find(item => item.name === p.name);
        if (existing) {
          existing.count += 1;
        } else {
          cart.push({ ...p, count: 1 });
        }
        saveCart();
        updateCartButton();
        updateButtonState();
      });

      updateButtonState();
      list.appendChild(el);
    });
  }

  function showCart() {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('cart-modal').style.display = 'block';

    const container = document.getElementById('cart-items');
    container.innerHTML = '';

    cart.forEach((item, index) => {
      const el = document.createElement("div");
      el.className = "cart-item";
      el.innerHTML = `
        ${item.name} × ${item.count}
        <button onclick="removeItem(${index})">Удалить</button>
      `;
      container.appendChild(el);
    });
  }

  function clearCart() {
    cart = [];
    saveCart();
    updateCartButton();
    showCart();
    loadProductsFromCSV();
  }

  function removeItem(index) {
    cart.splice(index, 1);
    saveCart();
    updateCartButton();
    showCart();
    loadProductsFromCSV();
  }

  document.getElementById('cart-button').onclick = showCart;
  document.getElementById('close-cart').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('cart-modal').style.display = 'none';
  };

  loadProductsFromCSV();
  updateCartButton();
</script>

</body>
</html>
